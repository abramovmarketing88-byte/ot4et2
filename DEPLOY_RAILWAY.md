# Запуск бота на Railway (постоянная работа 24/7)

Инструкция по деплою Avito Analytics Bot на [Railway](https://railway.app), чтобы бот работал постоянно без вашего компьютера.

---

## 1. Подготовка

### 1.1 Репозиторий

- Закоммитьте проект в **Git** (GitHub, GitLab или подключите папку к репозиторию).
- В корне должны быть: `main.py`, `requirements.txt`, `Dockerfile`, папки `bot/`, `core/`, `utils/`, `alembic/`.

### 1.2 Токен бота и Avito

- **BOT_TOKEN** — получите у [@BotFather](https://t.me/BotFather) в Telegram.
- **AVITO_CLIENT_ID** и **AVITO_CLIENT_SECRET** — из [кабинета разработчика Avito](https://www.avito.ru/profession/developer).
- **ADMIN_CHAT_ID** (по желанию) — ваш Telegram `chat_id` для уведомлений об ошибках (например, можно узнать у [@userinfobot](https://t.me/userinfobot)).

---

## 2. Создание проекта на Railway

### 2.1 Регистрация и проект

1. Зайдите на [railway.app](https://railway.app) и войдите (GitHub/GitLab).
2. Нажмите **"New Project"**.
3. Выберите **"Deploy from GitHub repo"** и укажите репозиторий с ботом (или **"Empty Project"**, если будете деплоить через CLI).

### 2.2 База данных PostgreSQL

1. В проекте нажмите **"+ New"** → **"Database"** → **"PostgreSQL"**.
2. Railway создаст БД и откроет вкладку сервиса.
3. Перейдите в **"Variables"** (или **"Connect"**) и скопируйте **DATABASE_URL** (или **POSTGRES_URL**).  
   Формат обычно: `postgresql://user:password@host:port/railway`.

4. Для этого бота URL должен быть с драйвером **asyncpg**.  
   Замените в начале строки:
   - `postgresql://` → `postgresql+asyncpg://`  
   Пример:  
   `postgresql+asyncpg://postgres:xxxxx@containers-us-west-xxx.railway.app:5432/railway`

---

## 3. Сервис бота

### 3.1 Добавить сервис из репозитория

1. В том же проекте нажмите **"+ New"** → **"GitHub Repo"** (или **"Empty Service"** для деплоя через CLI).
2. Укажите репозиторий. Если бот в подпапке (например `avito_analytics_bot`), в настройках сервиса задайте **Root Directory** = эта папка — иначе сборка не найдёт `main.py` и папки `bot/`, `core/`, `alembic/`.
3. Railway сам определит **Dockerfile** и соберёт образ.

### 3.2 Переменные окружения

В сервисе бота откройте **"Variables"** и добавьте:

| Переменная          | Обязательно | Описание |
|----------------------|-------------|----------|
| `BOT_TOKEN`          | Да          | Токен от @BotFather |
| `DATABASE_URL`       | Да          | URL PostgreSQL в формате `postgresql+asyncpg://user:pass@host:port/dbname` |
| `AVITO_CLIENT_ID`    | Да*         | Client ID приложения Avito |
| `AVITO_CLIENT_SECRET`| Да*         | Client Secret приложения Avito |
| `ADMIN_CHAT_ID`      | Нет         | Ваш Telegram chat_id для уведомлений об ошибках |

\* Нужны для работы с API Avito (профили, отчёты).

**Как подставить DATABASE_URL из PostgreSQL сервиса Railway:**

1. В сервисе PostgreSQL: **Variables** → скопировать `DATABASE_URL` или `POSTGRES_URL`.
2. В начале строки заменить `postgresql://` на `postgresql+asyncpg://`.
3. Вставить полученное значение в переменную `DATABASE_URL` сервиса бота.

Либо в Railway можно добавить переменную вручную и в значении использовать ссылку на переменную другой службы (если ваш план это поддерживает).

---

## 4. Сборка и запуск

### 4.1 Сборка

- **Build Command**: можно оставить по умолчанию (при использовании Dockerfile сборка идёт через Docker).
- **Root Directory**: если бот в подпапке репозитория (например `avito_analytics_bot`), укажите эту папку в настройках сервиса.

### 4.2 Команда запуска (Start Command) — важно

В **Dockerfile** по умолчанию запускается скрипт **`./run.sh`**: миграции (`alembic upgrade head`), затем **бесконечный** процесс бота (`python main.py`).

**В Railway → сервис worker → Settings → Custom Start Command:**

- **Либо оставьте поле пустым** — тогда будет использоваться команда из Dockerfile (`./run.sh`), бот будет работать постоянно.
- **Либо укажите ровно:** `./run.sh`

**Не указывайте** только `alembic upgrade head && python main.py`: при переопределении команды легко допустить ошибку, и контейнер после миграций может завершаться (статус "Completed" вместо постоянной работы). В логах при этом видны только сообщения Alembic, без строк вида `!!! [run.sh] ALEMBIC DONE, STARTING PYTHON !!!` и логов бота. Если видите только Alembic и статус "Completed" — очистите Custom Start Command и передеплойте.

### 4.3 Порт

Бот использует только исходящие запросы (Telegram API, Avito API) и **не слушает входящий HTTP**. Порт для веб-сервера указывать не нужно. Railway может показывать предупреждение о порте — для такого бота его можно игнорировать или оставить порт по умолчанию, если платформа этого требует.

---

## 5. Деплой

1. Сохраните все переменные и настройки.
2. Нажмите **"Deploy"** (или задеплойте через **Git push**, если подключён репозиторий).
3. В разделе **"Deployments"** дождитесь успешной сборки и запуска.
4. Откройте **"Logs"** — в логах должно появиться что-то вроде: `Bot started.`

---

## 6. Проверка

- Напишите боту в Telegram команду `/start`.
- Добавьте профиль Avito (`/profiles` → добавить профиль).
- Настройте отчёт и нажмите «Получить отчёт сейчас» или дождитесь отчёта по расписанию.

Если что-то пойдёт не так, смотрите **Logs** в Railway и проверьте переменные (особенно `BOT_TOKEN` и `DATABASE_URL`).

---

## 7. Важно: один экземпляр бота

С одним и тем же **BOT_TOKEN** может работать только **один** запущенный бот. Если бот запущен и локально, и на Railway (или в двух терминалах), Telegram выдаст ошибку **Conflict: only one bot instance is running** и отчёты/команды могут не доходить.

- При тестах **останавливайте** бота на Railway или локально — не держите оба запуска.
- На Railway: перед локальным запуском остановите сервис (или не деплойте, пока тестируете с компьютера).

## 8. Полезное

- **Перезапуск**: в карточке сервиса — **"Restart"**.
- **Логи**: **"Logs"** в реальном времени.
- **Переменные**: меняйте в **Variables** и при необходимости перезапустите сервис.
- **Миграции**: при следующем деплое выполнятся автоматически за счёт команды `alembic upgrade head` в Start Command.

---

## Краткий чеклист

1. Репозиторий с ботом в Git.
2. Railway: New Project → PostgreSQL + сервис из GitHub (или Empty Service).
3. В сервисе бота: `BOT_TOKEN`, `DATABASE_URL` (postgresql**+asyncpg**://...), `AVITO_CLIENT_ID`, `AVITO_CLIENT_SECRET`, при желании `ADMIN_CHAT_ID`.
4. Start Command: `alembic upgrade head && python main.py`.
5. Deploy → проверить логи и бота в Telegram.
6. Не запускайте бота с тем же токеном нигде ещё (ни локально, ни на другом сервере) — иначе будет конфликт и отчёты не будут приходить.

После этого бот будет работать на Railway постоянно, пока активна подписка и сервис не остановлен вручную.
